name: ğŸš€ Deploy Laravel App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ”¥ Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_KEY }}
        
    - name: ğŸš€ Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸ”„ DÃ©marrage du dÃ©ploiement..."
          
          # Navigation vers le rÃ©pertoire du projet
          cd /var/www/preums
          
          # Mise en mode maintenance
          echo "ğŸš§ Activation du mode maintenance..."
          sudo -u www-data php artisan down --render="errors::503" --retry=60 || true
          
          # Backup de la base de donnÃ©es (optionnel)
          echo "ğŸ’¾ Sauvegarde de la base de donnÃ©es..."
          sudo -u www-data php artisan backup:run --only-db --disable-notifications || true
          
          # RÃ©cupÃ©ration des derniers changements
          echo "ğŸ“¥ RÃ©cupÃ©ration du code..."
          sudo -u www-data git fetch origin
          sudo -u www-data git reset --hard origin/main
          
          # Installation des dÃ©pendances PHP
          echo "ğŸ˜ Installation des dÃ©pendances PHP..."
          sudo -u www-data composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
          
          # Installation des dÃ©pendances Node.js
          echo "ğŸ“¦ Installation des dÃ©pendances Node.js..."
          sudo -u www-data npm ci
          
          # Build des assets (Tailwind CSS + Vite)
          echo "ğŸ¨ Build des assets (Tailwind + Vite)..."
          sudo -u www-data npm run build
          
          # Optimisations Laravel
          echo "âš¡ Optimisations Laravel..."
          sudo -u www-data php artisan config:cache
          sudo -u www-data php artisan route:cache
          sudo -u www-data php artisan view:cache
          sudo -u www-data php artisan event:cache
          
          # Migrations de base de donnÃ©es
          echo "ğŸ—„ï¸ ExÃ©cution des migrations..."
          sudo -u www-data php artisan migrate --force
          
          # Nettoyage du cache applicatif
          echo "ğŸ§¹ Nettoyage des caches..."
          sudo -u www-data php artisan cache:clear
          
          # Storage link (si nÃ©cessaire)
          sudo -u www-data php artisan storage:link || true
          
          # Rechargement de PHP-FPM/Apache
          echo "ğŸ”„ Rechargement des services web..."
          sudo systemctl reload php8.3-fpm || sudo systemctl reload php8.2-fpm || sudo systemctl reload php8.1-fpm || true
          sudo systemctl reload nginx || sudo systemctl reload apache2 || true
          
          # DÃ©sactivation du mode maintenance
          echo "âœ… DÃ©sactivation du mode maintenance..."
          sudo -u www-data php artisan up
          
          # VÃ©rification de la santÃ© de l'application
          echo "ğŸ¥ VÃ©rification de la santÃ© de l'application..."
          curl -f http://localhost || echo "âš ï¸ Warning: Health check failed"
          
          echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"
          
    - name: ğŸ”” Notification de succÃ¨s
      if: success()
      run: |
        echo "âœ… DÃ©ploiement rÃ©ussi pour le commit ${{ github.sha }}"
        
    - name: ğŸš¨ Notification d'Ã©chec
      if: failure()
      run: |
        echo "âŒ Ã‰chec du dÃ©ploiement pour le commit ${{ github.sha }}"
